version: '3.8'

services:
  mongodb:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_DATABASE: foodie
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  auth:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    ports:
      - "4001:4001"
    environment:
      NODE_ENV: development
      PORT: 4001
      MONGODB_URI: mongodb://mongodb:27017/foodie
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
    depends_on:
      mongodb: { condition: service_healthy }
      redis: { condition: service_healthy }

  user:
    build:
      context: .
      dockerfile: services/user/Dockerfile
    ports:
      - "4002:4002"
    environment:
      NODE_ENV: development
      PORT: 4002
      MONGODB_URI: mongodb://mongodb:27017/foodie
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
    depends_on:
      mongodb: { condition: service_healthy }
      redis: { condition: service_healthy }

  restaurant:
    build:
      context: .
      dockerfile: services/restaurant/Dockerfile
    ports:
      - "4003:4003"
    environment:
      NODE_ENV: development
      PORT: 4003
      MONGODB_URI: mongodb://mongodb:27017/foodie
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
    depends_on:
      mongodb: { condition: service_healthy }
      redis: { condition: service_healthy }

  order:
    build:
      context: .
      dockerfile: services/order/Dockerfile
    ports:
      - "4004:4004"
    environment:
      NODE_ENV: development
      PORT: 4004
      MONGODB_URI: mongodb://mongodb:27017/foodie
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
    depends_on:
      mongodb: { condition: service_healthy }
      redis: { condition: service_healthy }

  payment:
    build:
      context: .
      dockerfile: services/payment/Dockerfile
    ports:
      - "4005:4005"
    environment:
      NODE_ENV: development
      PORT: 4005
      MONGODB_URI: mongodb://mongodb:27017/foodie
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
    depends_on:
      mongodb: { condition: service_healthy }
      redis: { condition: service_healthy }

  delivery:
    build:
      context: .
      dockerfile: services/delivery/Dockerfile
    ports:
      - "4006:4006"
    environment:
      NODE_ENV: development
      PORT: 4006
      MONGODB_URI: mongodb://mongodb:27017/foodie
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
    depends_on:
      mongodb: { condition: service_healthy }
      redis: { condition: service_healthy }

  admin:
    build:
      context: .
      dockerfile: services/admin/Dockerfile
    ports:
      - "4007:4007"
    environment:
      NODE_ENV: development
      PORT: 4007
      MONGODB_URI: mongodb://mongodb:27017/foodie
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
    depends_on:
      mongodb: { condition: service_healthy }
      redis: { condition: service_healthy }

  notification:
    build:
      context: .
      dockerfile: services/notification/Dockerfile
    ports:
      - "4008:4008"
    environment:
      NODE_ENV: development
      PORT: 4008
      MONGODB_URI: mongodb://mongodb:27017/foodie
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-change-me-in-production}
    depends_on:
      mongodb: { condition: service_healthy }
      redis: { condition: service_healthy }

  client:
    build:
      context: .
      dockerfile: client/Dockerfile
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_AUTH_URL: http://localhost:4001
      NEXT_PUBLIC_USER_URL: http://localhost:4002
      NEXT_PUBLIC_RESTAURANT_URL: http://localhost:4003
      NEXT_PUBLIC_ORDER_URL: http://localhost:4004
      NEXT_PUBLIC_PAYMENT_URL: http://localhost:4005
    depends_on:
      - auth

volumes:
  mongodb_data:
  redis_data:
